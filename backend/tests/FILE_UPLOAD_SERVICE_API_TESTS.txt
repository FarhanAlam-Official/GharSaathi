================================================================================
                    FILE UPLOAD SERVICE - API TESTS
================================================================================
Module: File Upload Service
Endpoints: 5 (Upload, Download, Delete, Get Details, List Files)
Base URL: http://localhost:8080/api/files
Authentication: Required (All authenticated users)
Status: ✅ Implemented & Compiled
================================================================================

PREREQUISITES:
--------------
1. Backend server running on port 8080
2. Database with file_uploads table
3. Upload directory created: ./uploads
4. Valid JWT token (any role)

To get JWT token, login as any user:
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@test.com","password":"password123"}'

Save the token from response: "token": "eyJhbGc..."

FILE UPLOAD CONFIGURATION:
--------------------------
- Max file size: 10MB
- Max request size: 10MB
- Allowed types: images/*, application/pdf
- Storage: Local filesystem (./uploads)
- Directory structure: ./uploads/{category}/{uuid-filename.ext}

FILE CATEGORIES:
----------------
1. PROPERTY_IMAGE - Images of properties
2. PROFILE_PICTURE - User profile pictures
3. DOCUMENT - General documents
4. LEASE_DOCUMENT - Lease agreements
5. PAYMENT_RECEIPT - Payment receipts/invoices

================================================================================
                        TEST 1: UPLOAD FILE
================================================================================

Endpoint: POST /api/files/upload
Description: Upload a file to the server
Role Required: Any authenticated user
Expected Status: 200 OK
Content-Type: multipart/form-data

--------------------------------------------------------------------------------
REQUEST (Upload Profile Picture):
----------------------------------
curl -X POST http://localhost:8080/api/files/upload \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@/path/to/profile.jpg" \
  -F "category=PROFILE_PICTURE"

EXPECTED RESPONSE:
------------------
{
  "id": 1,
  "fileName": "profile.jpg",
  "filePath": "profile_picture/a3f5b8c9-e4d7-4a2b-9c6f-1e8d4a7b2c5e.jpg",
  "fileUrl": "http://localhost:8080/api/files/1/download",
  "fileSize": 245678,
  "contentType": "image/jpeg",
  "fileCategory": "PROFILE_PICTURE",
  "uploadDate": "2026-01-28T15:30:00"
}

VALIDATION CHECKS:
------------------
✓ Status code is 200
✓ fileName matches original file name
✓ filePath includes category subdirectory
✓ filePath includes UUID (unique identifier)
✓ fileUrl is valid download link
✓ fileSize in bytes matches actual file
✓ contentType matches uploaded file type
✓ fileCategory matches requested category
✓ uploadDate is current timestamp (ISO 8601)

FILE STORAGE VERIFICATION:
--------------------------
1. Check file exists on filesystem:
   ./uploads/profile_picture/a3f5b8c9-e4d7-4a2b-9c6f-1e8d4a7b2c5e.jpg

2. Verify UUID filename (prevents conflicts)
3. Verify category subdirectory created
4. Verify original filename preserved in database
5. File accessible via download URL

--------------------------------------------------------------------------------
REQUEST (Upload Property Image):
---------------------------------
curl -X POST http://localhost:8080/api/files/upload \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@/path/to/property-exterior.jpg" \
  -F "category=PROPERTY_IMAGE"

EXPECTED RESPONSE:
------------------
{
  "id": 2,
  "fileName": "property-exterior.jpg",
  "filePath": "property_image/b7e2c4d1-f3a8-4e6d-8b9c-2d5f3a6e1b8c.jpg",
  "fileUrl": "http://localhost:8080/api/files/2/download",
  "fileSize": 1834567,
  "contentType": "image/jpeg",
  "fileCategory": "PROPERTY_IMAGE",
  "uploadDate": "2026-01-28T15:32:00"
}

VALIDATION CHECKS:
------------------
✓ Different UUID from previous upload
✓ Stored in property_image subdirectory
✓ Larger file size handled correctly

--------------------------------------------------------------------------------
REQUEST (Upload PDF Document):
-------------------------------
curl -X POST http://localhost:8080/api/files/upload \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@/path/to/lease-agreement.pdf" \
  -F "category=LEASE_DOCUMENT"

EXPECTED RESPONSE:
------------------
{
  "id": 3,
  "fileName": "lease-agreement.pdf",
  "filePath": "lease_document/c9d3e5f2-a4b7-4c8d-9e6f-3a7b2c5d4e8f.pdf",
  "fileUrl": "http://localhost:8080/api/files/3/download",
  "fileSize": 567234,
  "contentType": "application/pdf",
  "fileCategory": "LEASE_DOCUMENT",
  "uploadDate": "2026-01-28T15:35:00"
}

VALIDATION CHECKS:
------------------
✓ PDF file accepted
✓ contentType is application/pdf
✓ Stored in lease_document subdirectory
✓ File extension preserved (.pdf)

--------------------------------------------------------------------------------
REQUEST (Upload Payment Receipt):
----------------------------------
curl -X POST http://localhost:8080/api/files/upload \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@/path/to/receipt-january.pdf" \
  -F "category=PAYMENT_RECEIPT"

--------------------------------------------------------------------------------
REQUEST (Upload General Document):
-----------------------------------
curl -X POST http://localhost:8080/api/files/upload \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@/path/to/id-card.jpg" \
  -F "category=DOCUMENT"

ERROR CASES TO TEST:
--------------------

1. Empty File Upload:
   curl -X POST http://localhost:8080/api/files/upload \
     -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     -F "file=@/path/to/empty.txt" \
     -F "category=DOCUMENT"
   Expected: 400 Bad Request - "File is empty"

2. File Too Large (>10MB):
   curl -X POST http://localhost:8080/api/files/upload \
     -F "file=@/path/to/large-video.mp4" \
     -F "category=DOCUMENT"
   Expected: 413 Payload Too Large or 400 Bad Request

3. Invalid File Type (not image or PDF):
   curl -X POST http://localhost:8080/api/files/upload \
     -F "file=@/path/to/malware.exe" \
     -F "category=DOCUMENT"
   Expected: 400 Bad Request - "Invalid file type"

4. Path Traversal Attempt:
   curl -X POST http://localhost:8080/api/files/upload \
     -F "file=@/path/to/../../../etc/passwd" \
     -F "category=DOCUMENT"
   Expected: 400 Bad Request - "Invalid file name"

5. Missing File:
   curl -X POST http://localhost:8080/api/files/upload \
     -F "category=DOCUMENT"
   Expected: 400 Bad Request - "File is required"

6. Missing Category:
   curl -X POST http://localhost:8080/api/files/upload \
     -F "file=@/path/to/image.jpg"
   Expected: 400 Bad Request - "Category is required"

7. Invalid Category:
   curl -X POST http://localhost:8080/api/files/upload \
     -F "file=@/path/to/image.jpg" \
     -F "category=INVALID_CATEGORY"
   Expected: 400 Bad Request - Invalid enum value

8. No Authentication:
   curl -X POST http://localhost:8080/api/files/upload \
     -F "file=@/path/to/image.jpg"
   Expected: 401 Unauthorized

9. Video File (not allowed):
   curl -X POST http://localhost:8080/api/files/upload \
     -F "file=@/path/to/video.mp4" \
     -F "category=DOCUMENT"
   Expected: 400 Bad Request - "Only images and PDFs allowed"

10. Text File (not allowed):
    curl -X POST http://localhost:8080/api/files/upload \
      -F "file=@/path/to/document.txt" \
      -F "category=DOCUMENT"
    Expected: 400 Bad Request - "Invalid file type"

ALLOWED FILE TYPES:
-------------------
Images: .jpg, .jpeg, .png, .gif, .bmp, .webp, .svg
PDFs: .pdf

BLOCKED FILE TYPES:
-------------------
Videos: .mp4, .avi, .mov, .wmv
Audio: .mp3, .wav, .ogg
Archives: .zip, .rar, .tar, .gz
Executables: .exe, .bat, .sh, .cmd
Documents: .doc, .docx, .txt, .csv
Spreadsheets: .xls, .xlsx

================================================================================
                        TEST 2: DOWNLOAD FILE
================================================================================

Endpoint: GET /api/files/{fileId}/download
Description: Download a previously uploaded file
Role Required: Any authenticated user (no ownership check for download)
Expected Status: 200 OK

--------------------------------------------------------------------------------
REQUEST (Download by File ID):
-------------------------------
curl -X GET http://localhost:8080/api/files/1/download \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  --output downloaded-file.jpg

EXPECTED RESPONSE:
------------------
- Status: 200 OK
- Headers:
  Content-Type: image/jpeg
  Content-Disposition: attachment; filename="profile.jpg"
  Content-Length: 245678
- Body: Binary file content

VALIDATION CHECKS:
------------------
✓ Status code is 200
✓ Content-Type matches original file type
✓ Content-Disposition header includes original filename
✓ Content-Length matches file size
✓ Downloaded file is identical to uploaded file (byte-for-byte)
✓ File opens correctly in appropriate viewer

DOWNLOAD VERIFICATION:
----------------------
1. Compare file sizes:
   Original: 245678 bytes
   Downloaded: 245678 bytes
   ✓ Sizes match

2. Compare checksums:
   md5sum original.jpg
   md5sum downloaded-file.jpg
   ✓ Checksums match

3. Open file:
   ✓ Image displays correctly
   ✓ No corruption

--------------------------------------------------------------------------------
REQUEST (Download PDF):
-----------------------
curl -X GET http://localhost:8080/api/files/3/download \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  --output lease-agreement.pdf

EXPECTED RESPONSE:
------------------
- Content-Type: application/pdf
- Content-Disposition: attachment; filename="lease-agreement.pdf"
- PDF content downloads correctly

VALIDATION CHECKS:
------------------
✓ PDF opens in viewer
✓ All pages intact
✓ No corruption

BROWSER ACCESS:
---------------
Direct browser access (if logged in):
http://localhost:8080/api/files/1/download

Browser behavior:
- If image: May display inline
- If PDF: May display in PDF viewer
- Content-Disposition: attachment forces download

ERROR CASES TO TEST:
--------------------

1. File Not Found:
   curl -X GET http://localhost:8080/api/files/99999/download \
     -H "Authorization: Bearer YOUR_JWT_TOKEN"
   Expected: 404 Not Found - "File not found"

2. File Deleted from Filesystem (but DB record exists):
   - Delete ./uploads/category/uuid-file.jpg manually
   curl -X GET http://localhost:8080/api/files/1/download
   Expected: 500 Internal Server Error - "File not found on server"

3. No Authentication:
   curl -X GET http://localhost:8080/api/files/1/download
   Expected: 401 Unauthorized

4. Invalid File ID Format:
   curl -X GET http://localhost:8080/api/files/abc/download
   Expected: 400 Bad Request

SECURITY CONSIDERATIONS:
------------------------
✓ No ownership check on download (all authenticated users can download)
✓ Files stored with UUID names (prevents guessing)
✓ No directory traversal possible
✓ Content-Type validated on upload
✓ File IDs not sequential (UUID prevents enumeration)

FUTURE ENHANCEMENT:
-------------------
Consider adding ownership/permission checks:
- PROFILE_PICTURE: Only user or admins
- LEASE_DOCUMENT: Only landlord, tenant, or admins
- PAYMENT_RECEIPT: Only payer, payee, or admins
- PROPERTY_IMAGE: Public access
- DOCUMENT: Owner only

================================================================================
                        TEST 3: DELETE FILE
================================================================================

Endpoint: DELETE /api/files/{fileId}
Description: Delete an uploaded file (owner only)
Role Required: File owner or admin
Expected Status: 200 OK

--------------------------------------------------------------------------------
REQUEST (Owner Deletes Own File):
----------------------------------
curl -X DELETE http://localhost:8080/api/files/1 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"

EXPECTED RESPONSE:
------------------
"File deleted successfully"

VALIDATION CHECKS:
------------------
✓ Status code is 200
✓ Response message confirms deletion
✓ File removed from database
✓ Physical file deleted from filesystem
✓ Subsequent download attempts fail (404)

POST-DELETE VERIFICATION:
-------------------------
1. Try to download deleted file:
   curl -X GET http://localhost:8080/api/files/1/download
   Expected: 404 Not Found

2. Check file does not exist on filesystem:
   ls ./uploads/profile_picture/a3f5b8c9-...
   Expected: File not found

3. Try to get file details:
   curl -X GET http://localhost:8080/api/files/1
   Expected: 404 Not Found

4. Check database record removed:
   SELECT * FROM file_uploads WHERE id = 1
   Expected: 0 rows

DELETE WORKFLOW:
----------------
1. Verify file exists in database
2. Verify current user owns file (uploadedBy == currentUser)
3. Resolve physical file path
4. Delete physical file from filesystem
5. Delete database record
6. Return success message

ERROR CASES TO TEST:
--------------------

1. User Tries to Delete Another User's File:
   - User A uploads file (ID 5)
   - User B attempts to delete:
   curl -X DELETE http://localhost:8080/api/files/5 \
     -H "Authorization: Bearer USER_B_TOKEN"
   Expected: 403 Forbidden - "You don't have permission to delete this file"

2. File Not Found:
   curl -X DELETE http://localhost:8080/api/files/99999 \
     -H "Authorization: Bearer YOUR_JWT_TOKEN"
   Expected: 404 Not Found - "File not found"

3. File Already Deleted:
   curl -X DELETE http://localhost:8080/api/files/1 \
     -H "Authorization: Bearer YOUR_JWT_TOKEN"
   Expected: 404 Not Found (idempotent - no error)

4. No Authentication:
   curl -X DELETE http://localhost:8080/api/files/1
   Expected: 401 Unauthorized

5. Physical File Missing (DB record exists):
   - Delete file from filesystem manually
   - Try to delete via API:
   curl -X DELETE http://localhost:8080/api/files/1
   Expected: 200 OK (still deletes DB record)

ADMIN DELETION:
---------------
Admin should be able to delete any file:
curl -X DELETE http://localhost:8080/api/files/5 \
  -H "Authorization: Bearer ADMIN_TOKEN"
Expected: 200 OK

(Note: Current implementation may not have admin override - verify)

OWNERSHIP VERIFICATION:
-----------------------
Service checks: fileUpload.getUploadedBy().getId().equals(userId)
- User ID from JWT token
- Uploaded by ID from file record
- Must match exactly

CASCADE CONSIDERATIONS:
-----------------------
If file is referenced elsewhere:
- Property.images contains file URL
- User.profilePicture contains file URL
- Lease.documents contains file URL

Current: URLs become broken after file deletion
Future: Consider:
1. Prevent deletion if referenced
2. Remove references on deletion
3. Use soft delete (keep file, mark inactive)

================================================================================
                        TEST 4: GET FILE DETAILS
================================================================================

Endpoint: GET /api/files/{fileId}
Description: Get metadata about a file without downloading
Role Required: Any authenticated user
Expected Status: 200 OK

--------------------------------------------------------------------------------
REQUEST:
--------
curl -X GET http://localhost:8080/api/files/2 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"

EXPECTED RESPONSE:
------------------
{
  "id": 2,
  "fileName": "property-exterior.jpg",
  "filePath": "property_image/b7e2c4d1-f3a8-4e6d-8b9c-2d5f3a6e1b8c.jpg",
  "fileUrl": "http://localhost:8080/api/files/2/download",
  "fileSize": 1834567,
  "contentType": "image/jpeg",
  "fileCategory": "PROPERTY_IMAGE",
  "uploadDate": "2026-01-28T15:32:00"
}

VALIDATION CHECKS:
------------------
✓ Status code is 200
✓ All file metadata present
✓ fileUrl is clickable download link
✓ fileSize in bytes
✓ uploadDate in ISO 8601 format
✓ fileCategory matches enum value

USE CASES:
----------
1. Check file size before downloading
2. Verify file type
3. Get original filename
4. Get upload timestamp
5. Get category for filtering

ERROR CASES TO TEST:
--------------------

1. File Not Found:
   curl -X GET http://localhost:8080/api/files/99999 \
     -H "Authorization: Bearer YOUR_JWT_TOKEN"
   Expected: 404 Not Found - "File not found"

2. No Authentication:
   curl -X GET http://localhost:8080/api/files/2
   Expected: 401 Unauthorized

3. Invalid File ID:
   curl -X GET http://localhost:8080/api/files/abc
   Expected: 400 Bad Request

================================================================================
                        TEST 5: LIST MY FILES
================================================================================

Endpoint: GET /api/files/my-files
Description: List all files uploaded by current user
Role Required: Any authenticated user
Expected Status: 200 OK

--------------------------------------------------------------------------------
REQUEST (All User's Files):
----------------------------
curl -X GET http://localhost:8080/api/files/my-files \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"

EXPECTED RESPONSE:
------------------
[
  {
    "id": 1,
    "fileName": "profile.jpg",
    "filePath": "profile_picture/a3f5b8c9-e4d7-4a2b-9c6f-1e8d4a7b2c5e.jpg",
    "fileUrl": "http://localhost:8080/api/files/1/download",
    "fileSize": 245678,
    "contentType": "image/jpeg",
    "fileCategory": "PROFILE_PICTURE",
    "uploadDate": "2026-01-28T15:30:00"
  },
  {
    "id": 4,
    "fileName": "property-living-room.jpg",
    "filePath": "property_image/d5e8f2a3-b6c9-4d7e-9f8a-3b6c2d5e8f1a.jpg",
    "fileUrl": "http://localhost:8080/api/files/4/download",
    "fileSize": 1523678,
    "contentType": "image/jpeg",
    "fileCategory": "PROPERTY_IMAGE",
    "uploadDate": "2026-01-28T16:00:00"
  },
  {
    "id": 6,
    "fileName": "lease-2026.pdf",
    "filePath": "lease_document/f2a5b8c3-d7e9-4f8a-9b6c-3d5e2f8a1b7c.pdf",
    "fileUrl": "http://localhost:8080/api/files/6/download",
    "fileSize": 456789,
    "contentType": "application/pdf",
    "fileCategory": "LEASE_DOCUMENT",
    "uploadDate": "2026-01-28T17:15:00"
  }
]

VALIDATION CHECKS:
------------------
✓ Status code is 200
✓ Returns array of FileUploadResponse
✓ All files belong to current user (uploadedBy matches)
✓ Files sorted by uploadDate (newest first or oldest first)
✓ Empty array if user has no files

--------------------------------------------------------------------------------
REQUEST (Filter by Category - Profile Pictures Only):
------------------------------------------------------
curl -X GET "http://localhost:8080/api/files/my-files?category=PROFILE_PICTURE" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"

EXPECTED RESPONSE:
------------------
[
  {
    "id": 1,
    "fileName": "profile.jpg",
    "filePath": "profile_picture/a3f5b8c9-e4d7-4a2b-9c6f-1e8d4a7b2c5e.jpg",
    "fileUrl": "http://localhost:8080/api/files/1/download",
    "fileSize": 245678,
    "contentType": "image/jpeg",
    "fileCategory": "PROFILE_PICTURE",
    "uploadDate": "2026-01-28T15:30:00"
  }
]

VALIDATION CHECKS:
------------------
✓ Only files with category=PROFILE_PICTURE returned
✓ All files still belong to current user

--------------------------------------------------------------------------------
REQUEST (Filter by Category - Property Images):
------------------------------------------------
curl -X GET "http://localhost:8080/api/files/my-files?category=PROPERTY_IMAGE" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

VALIDATION CHECKS:
------------------
✓ Only PROPERTY_IMAGE files returned
✓ Useful for landlords managing property photos

--------------------------------------------------------------------------------
REQUEST (Filter by Category - Lease Documents):
------------------------------------------------
curl -X GET "http://localhost:8080/api/files/my-files?category=LEASE_DOCUMENT" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

VALIDATION CHECKS:
------------------
✓ Only LEASE_DOCUMENT files returned
✓ Useful for viewing all lease agreements

--------------------------------------------------------------------------------
REQUEST (Filter by Category - Payment Receipts):
-------------------------------------------------
curl -X GET "http://localhost:8080/api/files/my-files?category=PAYMENT_RECEIPT" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

VALIDATION CHECKS:
------------------
✓ Only PAYMENT_RECEIPT files returned
✓ Useful for financial records

USE CASES:
----------
1. User profile: Show all uploaded files with delete option
2. Property form: List PROPERTY_IMAGE files for selection
3. Profile editor: Show PROFILE_PICTURE files
4. Financial dashboard: Show PAYMENT_RECEIPT files
5. Document manager: Show all files with category filter

ERROR CASES TO TEST:
--------------------

1. No Authentication:
   curl -X GET http://localhost:8080/api/files/my-files
   Expected: 401 Unauthorized

2. Invalid Category:
   curl -X GET "http://localhost:8080/api/files/my-files?category=INVALID"
   Expected: 400 Bad Request - Invalid enum value

3. User Has No Files:
   - New user with no uploads
   curl -X GET http://localhost:8080/api/files/my-files
   Expected: 200 OK with empty array []

4. Category Has No Files:
   curl -X GET "http://localhost:8080/api/files/my-files?category=PAYMENT_RECEIPT"
   Expected: 200 OK with empty array [] (if user has no receipts)

================================================================================
                    INTEGRATION & CROSS-MODULE TESTS
================================================================================

TEST 6: Profile Picture Upload & Update
----------------------------------------
1. Upload profile picture:
   POST /api/files/upload (category=PROFILE_PICTURE)
   Response: fileUrl

2. Update user profile with picture URL:
   PUT /api/users/profile
   Body: {"profilePicture": "http://localhost:8080/api/files/1/download"}

3. Verify profile shows picture:
   GET /api/users/profile
   Response includes profilePicture URL

4. Download profile picture:
   GET /api/files/1/download
   Verify image displays correctly

TEST 7: Property Images Upload & Association
---------------------------------------------
1. Landlord uploads property images:
   POST /api/files/upload (category=PROPERTY_IMAGE)
   Collect fileUrls: [url1, url2, url3]

2. Create property with images:
   POST /api/landlord/properties
   Body: {"images": [url1, url2, url3], ...}

3. Verify property shows images:
   GET /api/properties/{id}
   Response includes images array

4. Download property images:
   GET /api/files/2/download, etc.

TEST 8: Lease Document Upload & Storage
----------------------------------------
1. Upload lease document:
   POST /api/files/upload (category=LEASE_DOCUMENT)
   Response: leaseDocUrl

2. Create lease with document:
   POST /api/leases
   Body: {"documentUrl": leaseDocUrl, ...}

3. Both parties download lease:
   - Landlord: GET /api/files/3/download
   - Tenant: GET /api/files/3/download
   Both should succeed

TEST 9: Payment Receipt Upload
-------------------------------
1. Tenant makes payment:
   POST /api/payments

2. Upload payment receipt:
   POST /api/files/upload (category=PAYMENT_RECEIPT)
   Response: receiptUrl

3. Update payment with receipt:
   PATCH /api/payments/{id}
   Body: {"receiptUrl": receiptUrl}

4. Landlord views payment and downloads receipt:
   GET /api/payments/{id} → get receiptUrl
   GET /api/files/4/download → download receipt

TEST 10: File Deletion Impact
------------------------------
1. Upload file and use URL in property:
   POST /api/files/upload → fileUrl
   POST /api/properties → includes fileUrl in images

2. Delete file:
   DELETE /api/files/1

3. Property still has URL but download fails:
   GET /api/properties/{id} → images includes fileUrl
   GET /api/files/1/download → 404 Not Found

4. Frontend should handle broken image gracefully

TEST 11: Multiple Files Upload for Property
--------------------------------------------
1. Upload 5 property images:
   POST /api/files/upload × 5
   Collect: [url1, url2, url3, url4, url5]

2. Create property with all images:
   POST /api/properties
   Body: {"images": [url1, url2, url3, url4, url5]}

3. List landlord's property images:
   GET /api/files/my-files?category=PROPERTY_IMAGE
   Should show all 5 files

4. Delete one image:
   DELETE /api/files/2

5. List again:
   GET /api/files/my-files?category=PROPERTY_IMAGE
   Should show 4 files

TEST 12: User File Management Dashboard
----------------------------------------
1. Get all user files:
   GET /api/files/my-files
   Group by category

2. Display statistics:
   - Total files: 10
   - Profile pictures: 2
   - Property images: 5
   - Lease documents: 2
   - Payment receipts: 1

3. Allow bulk operations:
   - Select multiple files
   - Delete selected (call DELETE for each)

TEST 13: File Size Limits
--------------------------
1. Upload 1MB file: ✓ Success
2. Upload 5MB file: ✓ Success
3. Upload 9.9MB file: ✓ Success
4. Upload 10.1MB file: ✗ Fails (413 or 400)
5. Upload 50MB file: ✗ Fails immediately

TEST 14: Concurrent Uploads
----------------------------
1. User A uploads file → Success
2. User B uploads file simultaneously → Success
3. Both files get unique UUIDs
4. No filename conflicts
5. Both users can download their files

TEST 15: File Type Validation
------------------------------
Test each allowed type:
✓ .jpg, .jpeg, .png, .gif, .bmp, .webp, .svg
✓ .pdf

Test blocked types:
✗ .mp4, .avi, .mov (videos)
✗ .mp3, .wav (audio)
✗ .exe, .bat, .sh (executables)
✗ .zip, .rar (archives)
✗ .doc, .docx, .txt (documents except PDF)

================================================================================
                         EXPECTED BEHAVIORS
================================================================================

✓ All endpoints require authentication
✓ File upload limited to 10MB
✓ Only images and PDFs allowed
✓ Files stored with UUID names (prevents conflicts)
✓ Category subdirectories created automatically
✓ Empty files rejected
✓ Path traversal attempts blocked
✓ Download returns proper Content-Disposition headers
✓ Delete requires ownership (user owns file)
✓ List files filters by current user only
✓ Category filter works correctly
✓ Physical files deleted on DELETE
✓ Database records cleaned up on DELETE

================================================================================
                         COMMON ISSUES & FIXES
================================================================================

ISSUE 1: Upload Directory Not Found
------------------------------------
Cause: ./uploads directory doesn't exist
Fix: FileStorageService @PostConstruct creates it
Verify: Check server logs for "Upload directory created"

ISSUE 2: File Size Limit Exceeded
----------------------------------
Cause: File larger than 10MB
Fix: Reduce file size or increase limit in application.properties
Current: spring.servlet.multipart.max-file-size=10MB

ISSUE 3: Invalid File Type
---------------------------
Cause: Trying to upload .doc, .txt, .mp4, etc.
Fix: Only images/* and application/pdf allowed
Solution: Convert to PDF or use allowed image format

ISSUE 4: Cannot Delete File
----------------------------
Cause: User trying to delete another user's file
Fix: Only file owner can delete
Solution: Admin feature needed for override

ISSUE 5: Broken File URLs After Deletion
-----------------------------------------
Cause: File deleted but URLs still in property/user records
Fix: Frontend should handle 404 gracefully
Future: Prevent deletion if file is referenced

ISSUE 6: Duplicate Filenames
-----------------------------
Cause: Multiple users upload "profile.jpg"
Fix: Files stored with UUID names, no conflicts
Display: Original filename preserved in database

ISSUE 7: File Missing from Filesystem
--------------------------------------
Cause: Manual deletion or storage failure
Fix: Database record exists but download fails
Solution: Implement file integrity checker

================================================================================
                    AUTOMATED TEST SCRIPT (Bash)
================================================================================

#!/bin/bash
# Save as: test-file-upload-api.sh

BASE_URL="http://localhost:8080/api"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "======================================"
echo "  File Upload Service API Tests"
echo "======================================"

# Login
echo -e "\nLogging in..."
LOGIN_RESPONSE=$(curl -s -X POST "$BASE_URL/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"user@test.com","password":"password123"}')
TOKEN=$(echo $LOGIN_RESPONSE | grep -o '"token":"[^"]*' | cut -d'"' -f4)

if [ -z "$TOKEN" ]; then
    echo -e "${RED}✗ FAIL${NC} - Login failed"
    exit 1
fi
echo -e "${GREEN}✓ PASS${NC} - Login successful"

# Test 1: Upload File
echo -e "\nTest 1: Upload File..."
# Create test image
echo "Test image content" > test-image.jpg
UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BASE_URL/files/upload" \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@test-image.jpg" \
  -F "category=PROFILE_PICTURE")
HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "200" ]; then
    FILE_ID=$(echo "$UPLOAD_RESPONSE" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
    echo -e "${GREEN}✓ PASS${NC} - Upload successful, File ID: $FILE_ID"
else
    echo -e "${RED}✗ FAIL${NC} - Status $HTTP_CODE"
fi

# Test 2: List My Files
echo -e "\nTest 2: List My Files..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X GET "$BASE_URL/files/my-files" \
  -H "Authorization: Bearer $TOKEN")
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "200" ]; then
    echo -e "${GREEN}✓ PASS${NC} - Status 200"
else
    echo -e "${RED}✗ FAIL${NC} - Status $HTTP_CODE"
fi

# Test 3: Download File
if [ ! -z "$FILE_ID" ]; then
    echo -e "\nTest 3: Download File..."
    HTTP_CODE=$(curl -s -w "%{http_code}" -X GET "$BASE_URL/files/$FILE_ID/download" \
      -H "Authorization: Bearer $TOKEN" \
      -o downloaded-file.jpg)
    if [ "$HTTP_CODE" = "200" ]; then
        echo -e "${GREEN}✓ PASS${NC} - Status 200"
    else
        echo -e "${RED}✗ FAIL${NC} - Status $HTTP_CODE"
    fi
fi

# Test 4: Delete File
if [ ! -z "$FILE_ID" ]; then
    echo -e "\nTest 4: Delete File..."
    HTTP_CODE=$(curl -s -w "%{http_code}" -X DELETE "$BASE_URL/files/$FILE_ID" \
      -H "Authorization: Bearer $TOKEN" \
      -o /dev/null)
    if [ "$HTTP_CODE" = "200" ]; then
        echo -e "${GREEN}✓ PASS${NC} - Status 200"
    else
        echo -e "${RED}✗ FAIL${NC} - Status $HTTP_CODE"
    fi
fi

# Cleanup
rm -f test-image.jpg downloaded-file.jpg

echo -e "\n======================================"
echo "  Tests Complete"
echo "======================================"

================================================================================
                              NOTES
================================================================================

1. File upload directory must exist before starting server
2. Only images and PDFs accepted for security
3. File size limited to 10MB (configurable)
4. Files stored with UUID to prevent conflicts
5. Category subdirectories organize files
6. Delete requires ownership verification
7. Download available to all authenticated users (consider adding permissions)
8. Empty files rejected
9. Path traversal blocked
10. Original filenames preserved in database

================================================================================
                          TEST DATA SETUP
================================================================================

Prepare test files:
1. Small image (< 1MB): test-small.jpg
2. Large image (5-10MB): test-large.jpg
3. PDF document: test-document.pdf
4. Too large file (>10MB): test-toolarge.jpg
5. Invalid type file: test-invalid.exe
6. Empty file: test-empty.txt

Sample images available in: tests/sample-files/

================================================================================
                              END OF FILE
================================================================================
